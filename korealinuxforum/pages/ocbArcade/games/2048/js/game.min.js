function GameManager(a,b,c,d){this.size=a,this.inputManager=new b,this.storageManager=new d,this.actuator=new c,this.value=2048,this.lastStorageState=[],this.stateIndex=0,this.startTiles=2,this.ua=navigator.userAgent.toLowerCase(),this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.setup()}function Grid(a,b){this.size=a,this.cells=b?this.fromState(b):this.empty()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-text"),this.bestContainer=document.querySelector(".best-text"),this.messageContainerOrigin=document.querySelector(".game-message"),this.messageContainer=document.querySelector(".gameResult"),this.score=0}function KeyboardInputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function LocalStorageManager(){this.bestScoreKey="7bestScore",this.gameStateKey="7gameState",this.userStateKey="7userState",this.lastStateKey="7lastState",this.bestLevelKey="7bestLevel",this.bestRateKey="7bestRate";var a=this.localStorageSupported();this.storage=a?window.localStorage:window.fakeStorage}function Tile(a,b){this.x=a.x,this.y=a.y,this.value=b||2,this.previousPosition=null,this.mergedFrom=null}Function.prototype.bind=Function.prototype.bind||function(a){var b=this;return function(c){c instanceof Array||(c=[c]),b.apply(a,c)}},function(){function a(a){this.el=a;for(var b=a.className.replace(/^\s+|\s+$/g,"").split(/\s+/),c=0;c<b.length;c++)d.call(this,b[c])}function b(a,b,c){Object.defineProperty?Object.defineProperty(a,b,{get:c}):a.__defineGetter__(b,c)}if(!("undefined"==typeof window.Element||"classList"in document.documentElement)){var c=Array.prototype,d=c.push,e=c.splice,f=c.join;a.prototype={add:function(a){this.contains(a)||(d.call(this,a),this.el.className=this.toString())},contains:function(a){return-1!=this.el.className.indexOf(a)},item:function(a){return this[a]||null},remove:function(a){if(this.contains(a)){for(var b=0;b<this.length&&this[b]!=a;b++);e.call(this,b,1),this.el.className=this.toString()}},toString:function(){return f.call(this," ")},toggle:function(a){return this.contains(a)?this.remove(a):this.add(a),this.contains(a)}},window.DOMTokenList=a,b(HTMLElement.prototype,"classList",function(){return new a(this)})}}(),GameManager.prototype.restart=function(){this.storageManager.clearGameState(),this.actuator.continueGame(),this.lastStorageState=[],this.stateIndex=0,this.setup()},GameManager.prototype.clearGame=function(){this.storageManager.clearGameState()},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continueGame()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying},GameManager.prototype.setup=function(){var a,b;/Android 2/i.test(this.ua)||(a=this.storageManager.getGameState(),b=JSON.parse(this.storageManager.getLastState())),a?(this.grid=new Grid(a.grid.size,a.grid.cells),this.score=a.score,this.over=a.over,this.won=a.won,this.keepPlaying=a.keepPlaying,this.undoCount=a.undoCount,this.started=a.started,this.lastStorageState=b.lastStorageState,this.stateIndex=b.stateIndex):(this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.undoCount=this.undoCount,this.started=!1,this.lastStorageState=[],this.stateIndex=0,this.addStartTiles()),this.actuate()},GameManager.prototype.addStartTiles=function(){for(var a=0;a<this.startTiles;a++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var a=Math.random()<.9?2:4,b=new Tile(this.grid.randomAvailableCell(),a);this.grid.insertTile(b)}},GameManager.prototype.actuate=function(){console.log(this.storageManager.getBestScore()),this.storageManager.getBestScore()<this.score&&this.storageManager.setBestScore(this.score),this.movesAvailable()&&(this.over=!1),this.over?this.storageManager.clearGameState():(this.storageManager.setGameState(this.serialize()),this.storageManager.setLastState(this.lastGameSerialize())),console.log("over :"+this.over),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),value:this.value,terminated:this.isGameTerminated()})},GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying,started:this.started,undoCount:this.undoCount}},GameManager.prototype.lastGameSerialize=function(){return{lastStorageState:this.lastStorageState,stateIndex:this.stateIndex}},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(a,b,c){c&&(c.mergedFrom=null,c.savePosition())})},GameManager.prototype.moveTile=function(a,b){this.grid.cells[a.x][a.y]=null,this.grid.cells[b.x][b.y]=a,a.updatePosition(b)},GameManager.prototype.move=function(a){var b=this;if(!this.isGameTerminated()){var c,d,e=this.getVector(a),f=this.buildTraversals(e),g=!1;this.prepareTiles(),f.x.forEach(function(a){f.y.forEach(function(f){if(c={x:a,y:f},d=b.grid.cellContent(c)){var h=b.findFarthestPosition(c,e),i=b.grid.cellContent(h.next);if(i&&i.value===d.value&&!i.mergedFrom){var j=new Tile(h.next,2*d.value);j.mergedFrom=[d,i],b.grid.insertTile(j),b.grid.removeTile(d),d.updatePosition(h.next),b.score+=j.value,2048===j.value&&(b.value=2048,b.won=!0),4096===j.value&&(b.value=4096,b.won=!0)}else b.moveTile(d,h.farthest);b.positionsEqual(c,d)||(g=!0)}})}),console.log("moved :"+g),g&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.lastStorageState[this.stateIndex%3]=this.storageManager.getGameState(),this.stateIndex++,console.log(this.lastStorageState),this.actuate())}},GameManager.prototype.getVector=function(a){var b={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return b[a]},GameManager.prototype.buildTraversals=function(a){for(var b={x:[],y:[]},c=0;c<this.size;c++)b.x.push(c),b.y.push(c);return 1===a.x&&(b.x=b.x.reverse()),1===a.y&&(b.y=b.y.reverse()),b},GameManager.prototype.findFarthestPosition=function(a,b){var c;do c=a,a={x:c.x+b.x,y:c.y+b.y};while(this.grid.withinBounds(a)&&this.grid.cellAvailable(a));return{farthest:c,next:a}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var a,b=this,c=0;c<this.size;c++)for(var d=0;d<this.size;d++)if(a=this.grid.cellContent({x:c,y:d}))for(var e=0;4>e;e++){var f=b.getVector(e),g={x:c+f.x,y:d+f.y},h=b.grid.cellContent(g);if(h&&h.value===a.value)return!0}return!1},GameManager.prototype.positionsEqual=function(a,b){return a.x===b.x&&a.y===b.y},Grid.prototype.empty=function(){for(var a=[],b=0;b<this.size;b++)for(var c=a[b]=[],d=0;d<this.size;d++)c.push(null);return a},Grid.prototype.fromState=function(a){for(var b=[],c=0;c<this.size;c++)for(var d=b[c]=[],e=0;e<this.size;e++){var f=a[c][e];d.push(f?new Tile(f.position,f.value):null)}return b},Grid.prototype.randomAvailableCell=function(){var a=this.availableCells();return a.length?a[Math.floor(Math.random()*a.length)]:void 0},Grid.prototype.availableCells=function(){var a=[];return this.eachCell(function(b,c,d){d||a.push({x:b,y:c})}),a},Grid.prototype.eachCell=function(a){for(var b=0;b<this.size;b++)for(var c=0;c<this.size;c++)a(b,c,this.cells[b][c])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(a){return!this.cellOccupied(a)},Grid.prototype.cellOccupied=function(a){return!!this.cellContent(a)},Grid.prototype.cellContent=function(a){return this.withinBounds(a)?this.cells[a.x][a.y]:null},Grid.prototype.insertTile=function(a){this.cells[a.x][a.y]=a},Grid.prototype.removeTile=function(a){this.cells[a.x][a.y]=null},Grid.prototype.withinBounds=function(a){return a.x>=0&&a.x<this.size&&a.y>=0&&a.y<this.size},Grid.prototype.serialize=function(){for(var a=[],b=0;b<this.size;b++)for(var c=a[b]=[],d=0;d<this.size;d++)c.push(this.cells[b][d]?this.cells[b][d].serialize():null);return{size:this.size,cells:a}},HTMLActuator.prototype.actuate=function(a,b){var c=this;window.requestAnimationFrame(function(){c.clearContainer(c.tileContainer),a.cells.forEach(function(a){a.forEach(function(a){a&&c.addTile(a)})}),c.updateScore(b.score),c.updateBestScore(b.bestScore),console.log(b.keepPlay),b.terminated&&(b.over?window.setTimeout(function(){c.message(!1,b.score,b.bestScore,null)},1e3):b.won&&c.message(!0,b.score,b.bestScore,b.value))})},HTMLActuator.prototype.continueGame=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(a){for(;a.firstChild;)a.removeChild(a.firstChild)},HTMLActuator.prototype.addTile=function(a){var b=this,c=document.createElement("div"),d=document.createElement("div"),e=a.previousPosition||{x:a.x,y:a.y},f=this.positionClass(e),g=["tile","tile-"+a.value,f];a.value>2048&&g.push("tile-super"),this.applyClasses(c,g),d.classList.add("tile-inner"),d.textContent=a.value,a.previousPosition?window.requestAnimationFrame(function(){g[2]=b.positionClass({x:a.x,y:a.y}),b.applyClasses(c,g)}):a.mergedFrom?(g.push("tile-merged"),this.applyClasses(c,g),a.mergedFrom.forEach(function(a){b.addTile(a)})):(g.push("tile-new"),this.applyClasses(c,g)),c.appendChild(d),this.tileContainer.appendChild(c)},HTMLActuator.prototype.applyClasses=function(a,b){a.setAttribute("class",b.join(" "))},HTMLActuator.prototype.normalizePosition=function(a){return{x:a.x+1,y:a.y+1}},HTMLActuator.prototype.positionClass=function(a){return a=this.normalizePosition(a),"tile-position-"+a.x+"-"+a.y},HTMLActuator.prototype.updateScore=function(a){this.clearContainer(this.scoreContainer);a-this.score;this.score=a,this.scoreContainer.textContent=this.score},HTMLActuator.prototype.updateBestScore=function(a){this.bestContainer.textContent=a},HTMLActuator.prototype.message=function(a,b,c,d){var e=a?"game-won":"game-over";a?this.messageContainerOrigin.classList.add(e):$("#game_play").trigger("finish",[b,c])},HTMLActuator.prototype.clearMessage=function(){this.messageContainerOrigin.classList.remove("game-won"),this.messageContainerOrigin.classList.remove("game-over")},KeyboardInputManager.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].push(b)},KeyboardInputManager.prototype.emit=function(a,b){var c=this.events[a];c&&c.forEach(function(a){a(b)})},KeyboardInputManager.prototype.listen=function(){var a=this,b={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(c){var d=c.altKey||c.ctrlKey||c.metaKey||c.shiftKey,e=b[c.which];d||void 0!==e&&(c.preventDefault(),a.emit("move",e)),d||82!==c.which||a.restart.call(a,c)}),this.bindButtonPress(".keep-playing-button",this.keepPlaying);var c,d,e=document.getElementsByClassName("game-container")[0];e.addEventListener(this.eventTouchstart,function(a){!window.navigator.msPointerEnabled&&a.touches.length>1||a.targetTouches>1||(window.navigator.msPointerEnabled?(c=a.pageX,d=a.pageY):(c=a.touches[0].clientX,d=a.touches[0].clientY),a.preventDefault())}),e.addEventListener(this.eventTouchmove,function(a){a.preventDefault()}),e.addEventListener(this.eventTouchend,function(b){if(!(!window.navigator.msPointerEnabled&&b.touches.length>0||b.targetTouches>0)){var e,f;window.navigator.msPointerEnabled?(e=b.pageX,f=b.pageY):(e=b.changedTouches[0].clientX,f=b.changedTouches[0].clientY);var g=e-c,h=Math.abs(g),i=f-d,j=Math.abs(i);Math.max(h,j)>10&&a.emit("move",h>j?g>0?1:3:i>0?2:0)}})},KeyboardInputManager.prototype.restart=function(a){a.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(a){a.preventDefault(),this.emit("keepPlaying")},KeyboardInputManager.prototype.bindButtonPress=function(a,b){var c=document.querySelector(a);c.addEventListener("click",b.bind(this)),c.addEventListener(this.eventTouchend,b.bind(this))},window.fakeStorage={_data:{},setItem:function(a,b){return this._data[a]=String(b)},getItem:function(a){return this._data.hasOwnProperty(a)?this._data[a]:void 0},removeItem:function(a){return delete this._data[a]},clear:function(){return this._data={}}},LocalStorageManager.prototype.localStorageSupported=function(){var a="test",b=window.localStorage;try{return b.setItem(a,"1"),b.removeItem(a),!0}catch(c){return!1}},LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorageManager.prototype.setBestScore=function(a){this.storage.setItem(this.bestScoreKey,a)},LocalStorageManager.prototype.getBestLevel=function(){return this.storage.getItem(this.bestLevelKey)||0},LocalStorageManager.prototype.setBestLevel=function(a){this.storage.setItem(this.bestLevelKey,a)},LocalStorageManager.prototype.getBestRate=function(){return this.storage.getItem(this.bestRateKey)||0},LocalStorageManager.prototype.setBestRate=function(a){this.storage.setItem(this.bestRateKey,a)},LocalStorageManager.prototype.getGameState=function(){var a=this.storage.getItem(this.gameStateKey);return a?JSON.parse(a):null},LocalStorageManager.prototype.setGameState=function(a){this.storage.setItem(this.gameStateKey,JSON.stringify(a))},LocalStorageManager.prototype.getUserState=function(){return this.storage.getItem(this.userStateKey)},LocalStorageManager.prototype.setUserState=function(a){this.storage.setItem(this.userStateKey,JSON.stringify(a))},LocalStorageManager.prototype.getLastState=function(){return this.storage.getItem(this.lastStateKey)},LocalStorageManager.prototype.setLastState=function(a){this.storage.setItem(this.lastStateKey,JSON.stringify(a))},LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey),this.storage.removeItem(this.lastStateKey)},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(a){this.x=a.x,this.y=a.y},Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}},$(function(a,b,c){function d(a){var b,c,d,e,f,g=[{levelDesc:"초하수",levelID:"lv-6",startPnt:0,endPnt:964,startRate:97,endRate:100},{levelDesc:"하수",levelID:"lv-5",startPnt:965,endPnt:2376,startRate:84,endRate:97},{levelDesc:"중수",levelID:"lv-4",startPnt:2377,endPnt:15680,startRate:16,endRate:84},{levelDesc:"고수",levelID:"lv-3",startPnt:15681,endPnt:36500,startRate:4,endRate:16},{levelDesc:"초고수",levelID:"lv-2",startPnt:36501,endPnt:132728,startRate:.1,endRate:3},{levelDesc:"신(神)",levelID:"lv-1",startPnt:132729,endPnt:"Infinity",startRate:0,endRate:.1}],h=g.length;for(c=0;h>c;c++)if(b=g[c],!(b.startPnt>a||b.endPnt<a)){d=b.levelDesc,e=b.levelID,f=function(){var c,d=(b.endRate-b.startRate)/(b.endPnt-b.startPnt);return c=b.endRate-d*(a-b.startPnt),.1>=c&&(c=.1),c>100&&(c=100),c>.1&&(c=10*c,c=Math.ceil(c),c/=10),c.toString()}();break}return console.log(d),console.log(e),console.log(f),{levelDesc:d,levelID:e,rate:f}}var e,f,g=(b(".startBtn"),b(".restartBtn")),h=b(".backBtn"),i=(b(".layerWrapper"),b(".bestScore")),j=b("#game_play"),k=navigator.userAgent.toLowerCase();b(c).ready(function(){(a.innerWidth-200)/2;if(e=new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager),!/Android 2/i.test(k)&&(f=e.storageManager.getBestScore(),i.text(f),f>0)){var b=d(f);e.storageManager.setBestLevel(b.levelID),e.storageManager.setBestRate(b.rate)}}),g.on("click",function(b){b.preventDefault(),a.location.reload()}),h.on("click",function(){a.location.href="http://egame.skmcgw.com/planetArcade/client/index.html"}),j.on("finish",function(a,c){var g=d(c);b(".p2 strong").addClass(g.levelID),b(".p1 strong").text(g.rate),b(".game-result").removeClass("hidden"),c>f&&(i.text(c),/Android 2/i.test(k)||(e.storageManager.setBestScore(c),e.storageManager.setBestLevel(g.levelID),e.storageManager.setBestRate(g.rate)))})}(window,jQuery,document));