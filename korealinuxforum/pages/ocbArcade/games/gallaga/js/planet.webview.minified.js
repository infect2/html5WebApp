(function(){function b(e){function r(e){self.item=function(){return this.item.id};return this[e]}var t=e.length,n;for(n=0;n<t;n++)this[n]=e[n];this.length=t}if(!window.DirectCanvasSync){return}window.addEventListener("resize",function(){DirectCanvasSync.setHTMLContentsSize(window.innerWidth,window.innerHeight)});window.addEventListener("unload",function(){DirectCanvasSync.onCanvasUnload()});if(!Function.prototype.bind){Function.prototype.bind=function(e){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};r.prototype=this.prototype;i.prototype=new r;return i}}var e=function(e,t){if(e<=0||t<=0)throw"IndexSizeError";this.id=Math.random().toString(8);this.width=e;this.height=t;this.data=new Uint8Array(e*t*4);this.data.length=e*t*4};var t=function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0};var n=function(e,n){var r=e.replace(/[^A-Za-z0-9\+\/]/g,""),i=r.length,s=n?Math.ceil((i*3+1>>2)/n)*n:i*3+1>>2,o=new Uint8Array(s);for(var u,a,f=0,l=0,c=0;c<i;c++){a=c&3;f|=t(r.charCodeAt(c))<<18-6*a;if(a===3||i-c===1){for(u=0;u<3&&l<s;u++,l++){o[l]=f>>>(16>>>u&24)&255}f=0}}return o};var r=function(e){return e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65};var s=function(e){var t,n="";for(var i=e.length,s=0,o=0;o<i;o++){t=o%3;if(o>0&&o*4/3%76===0){n+="\r\n"}s|=e[o]<<(16>>>t&24);if(t===2||e.length-o===1){n+=String.fromCharCode(r(s>>>18&63),r(s>>>12&63),r(s>>>6&63),r(s&63));s=0}}return n.replace(/A(?=A$|$)/g,"=")};var o=function(e){var t="";for(var n,r=e.length,i=0;i<r;i++){n=e[i];t+=String.fromCharCode(n>251&&n<254&&i+5<r?(n-252)*1073741824+(e[++i]-128<<24)+(e[++i]-128<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>247&&n<252&&i+4<r?(n-248<<24)+(e[++i]-128<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>239&&n<248&&i+3<r?(n-240<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>223&&n<240&&i+2<r?(n-224<<12)+(e[++i]-128<<6)+e[++i]-128:n>191&&n<224&&i+1<r?(n-192<<6)+e[++i]-128:n)}return t};var u=function(e){var t,n,r=e.length,i=0;for(var s=0;s<r;s++){n=e.charCodeAt(s);i+=n<128?1:n<2048?2:n<65536?3:n<2097152?4:n<67108864?5:6}t=new Uint8Array(i);for(var o=0,u=0;o<i;u++){n=e.charCodeAt(u);if(n<128){t[o++]=n}else if(n<2048){t[o++]=192+(n>>>6);t[o++]=128+(n&63)}else if(n<65536){t[o++]=224+(n>>>12);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}else if(n<2097152){t[o++]=240+(n>>>18);t[o++]=128+(n>>>12&63);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}else if(n<67108864){t[o++]=248+(n>>>24);t[o++]=128+(n>>>18&63);t[o++]=128+(n>>>12&63);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}else{t[o++]=252+n/1073741824;t[o++]=128+(n>>>24&63);t[o++]=128+(n>>>18&63);t[o++]=128+(n>>>12&63);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}}return t};var a=function(e){var t=/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/.exec(e);return t?"#"+(1<<24|t[1]<<16|t[2]<<8|t[3]).toString(16).substr(1):null};Object.deepExtend=function(e,t){e["__isCopied__"]=true;for(var n in t){try{if(typeof t[n]==="object"&&t[n]!==null){e[n]=e[n]||{};arguments.callee(e[n],t[n])}else{e[n]=t[n]}}catch(r){console.log(r)}}return e};var f=function(e,t,n,r){this.id=Math.random().toString(8);DirectCanvasSync.registerLinearGradient(this.id,e,t,n,r)};f.prototype.addColorStop=function(e,t){var n=a(t);if(n!=null)t=n;DirectCanvasSync.linearGradientAddColorStop(this.id,e,t)};var l=document.createElement("canvas");Object.deepExtend(l,HTMLCanvasElement.prototype);var c=l.getContext("2d");Object.deepExtend(c,CanvasRenderingContext2D.prototype);(function(){if(l==null||l.isCopied==false||c==null||c.isCopied==false){alert("Each of NativeCanvas and NativeCanvasRenderingContext2D should preserve native properties and functions.")}})();document.getElementById=function(e){return function(t){var n=e.call(this,t);if(n==null){return null}else if(n.tagName.toLowerCase()=="canvas"&&!!n.__isDirectCanvas__==false){return h(n)}else{return n}}}(document.getElementById);document.createElement=function(e){return function(t){var n=e.call(this,t);if(n.tagName.toLowerCase()=="canvas"){return h(n)}else{return n}}}(document.createElement);var h=function(e){if(e.tagName.toLowerCase()=="canvas"&&!!e.__isDirectCanvas__==false){e.__isDirectCanvas__=true;var t=e.width;var n=e.height;e.getContext("2d");e.__defineGetter__("width",function(){return e._width});e.__defineSetter__("width",function(t){e._width=t;l.setAttribute.call(this,"width",t);DirectCanvasSync.setCanvasWidth(this.__directCanvasId__,t)});e.__defineGetter__("height",function(){return e._height});e.__defineSetter__("height",function(t){e._height=t;l.setAttribute.call(this,"height",t);DirectCanvasSync.setCanvasHeight(this.__directCanvasId__,t)});if(t>0){e.width=t}if(n>0){e.height=n}}return e};var p=function(e){var t=window.getComputedStyle(e,null);this.size={};this.origin={};this.size.width=parseInt(t.width,10)||e.width||0;this.size.height=parseInt(t.height,10)||e.height||0;this.origin.x=parseInt(t.left,10)||0;this.origin.y=parseInt(t.top,10)||0;this.zIndex=parseInt(t.zIndex,10)||0;var n=parseInt(t.right,10)||0;var r=parseInt(t.bottom,10)||0;if(this.origin.y==0&&r>0){this.origin.y=window.innerHeight-this.size.height-r}if(this.origin.x==0&&n>0){this.origin.x=window.innerWidth-this.size.width-n}};HTMLCanvasElement.prototype.getContext=function(e){if(this.context2D){return this.context2D}var t=l.getContext.call(this,e);this.context2D=t;var n=new p(this);this.__directCanvasId__=DirectCanvasSync.createCanvas(n.origin.y,n.origin.x,n.size.width,n.size.height,n.zIndex);DirectCanvasSync.setHTMLContentsSize(window.innerWidth,window.innerHeight);t.flush=function(){var e=new p(this.canvas);DirectCanvasSync.attachCanvas(this.canvas.__directCanvasId__,e.zIndex);DirectCanvasSync.setCanvasX(this.canvas.__directCanvasId__,e.origin.x);DirectCanvasSync.setCanvasY(this.canvas.__directCanvasId__,e.origin.y);t.flush=function(){DirectCanvasSync.flush(this.canvas.__directCanvasId__)}};t.__defineGetter__("fillStyle",function(){return t._fillStyle});t.__defineSetter__("fillStyle",function(e){t._fillStyle=e;if(e instanceof f){DirectCanvasSync.setGradientStyle(t.canvas.__directCanvasId__,e.id)}else{var n=a(e);if(n==null)DirectCanvasSync.setFillStyle(t.canvas.__directCanvasId__,e);else DirectCanvasSync.setFillStyle(t.canvas.__directCanvasId__,n)}});t.__defineGetter__("strokeStyle",function(){return t._strokeStyle});t.__defineSetter__("strokeStyle",function(e){t._strokeStyle=e;var n=a(e);if(n==null)DirectCanvasSync.setStrokeStyle(t.canvas.__directCanvasId__,e);else DirectCanvasSync.setStrokeStyle(t.canvas.__directCanvasId__,n)});t.__defineGetter__("lineWidth",function(){return t._lineWidth});t.__defineSetter__("lineWidth",function(e){t._lineWidth=e;DirectCanvasSync.setLineWidth(t.canvas.__directCanvasId__,e)});t.__defineGetter__("font",function(){return t._font});t.__defineSetter__("font",function(e){t._font=e;DirectCanvasSync.setFontInfo(t.canvas.__directCanvasId__,e)});t.__defineGetter__("globalAlpha",function(){return t._globalAlpha});t.__defineSetter__("globalAlpha",function(e){t._globalAlpha=e;if(e<0){e=0}else if(e>1){e=1}DirectCanvasSync.setGlobalAlpha(t.canvas.__directCanvasId__,e)});return this.context2D};CanvasRenderingContext2D.prototype.fillText=function(e,t,n){DirectCanvasSync.fillText(this.canvas.__directCanvasId__,e,t,n)};CanvasRenderingContext2D.prototype.strokeText=function(e,t,n){DirectCanvasSync.strokeText(this.canvas.__directCanvasId__,e,t,n)};CanvasRenderingContext2D.prototype.beginPath=function(){DirectCanvasSync.beginPath(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.closePath=function(){DirectCanvasSync.closePath(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.arc=function(e,t,n,r,i,s){DirectCanvasSync.arc(this.canvas.__directCanvasId__,e,t,n,r,i,s)};CanvasRenderingContext2D.prototype.fill=function(){DirectCanvasSync.fill(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.stroke=function(){DirectCanvasSync.stroke(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.moveTo=function(e,t){DirectCanvasSync.moveTo(this.canvas.__directCanvasId__,e,t)};CanvasRenderingContext2D.prototype.bezierCurveTo=function(e,t,n,r,i,s){DirectCanvasSync.bezierCurveTo(this.canvas.__directCanvasId__,e,t,n,r,i,s)};CanvasRenderingContext2D.prototype.quadraticCurveTo=function(e,t,n,r){DirectCanvasSync.quadraticCurveTo(this.canvas.__directCanvasId__,e,t,n,r)};CanvasRenderingContext2D.prototype.lineTo=function(e,t){_lastAPI="lineTo";DirectCanvasSync.lineTo(this.canvas.__directCanvasId__,e,t)};CanvasRenderingContext2D.prototype.clearRect=function(e,t,n,r){DirectCanvasSync.clearRect(this.canvas.__directCanvasId__,e,t,n,r)};CanvasRenderingContext2D.prototype.clip=function(){DirectCanvasSync.clip(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.rect=function(e,t,n,r){DirectCanvasSync(this.canvas.__directCanvasId__,e,t,n,r)};CanvasRenderingContext2D.prototype.fillRect=function(e,t,n,r){DirectCanvasSync.fillRect(this.canvas.__directCanvasId__,e,t,n,r)};CanvasRenderingContext2D.prototype.strokeRect=function(e,t,n,r){DirectCanvasSync.fillRect(this.canvas.__directCanvasId__,e,t,n,r)};CanvasRenderingContext2D.prototype.measureText=function(e){var t=DirectCanvasSync.measureText(this.canvas.__directCanvasId__,e);return JSON.parse(t)};CanvasRenderingContext2D.prototype.save=function(){DirectCanvasSync.saveContext(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.restore=function(){DirectCanvasSync.restoreContext(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.drawImage=function(e,t,n,r,i,s,o,u,a){var f=e.imageId|e.__directCanvasId__;if(arguments.length==9){DirectCanvasSync.drawImage(this.canvas.__directCanvasId__,f,e.tagName,t,n,r,i,s,o,u,a)}else if(arguments.length==3){DirectCanvasSync.drawImage(this.canvas.__directCanvasId__,f,e.tagName,0,0,e.width,e.height,t,n,e.width,e.height)}else if(arguments.length==5){DirectCanvasSync.drawImage(this.canvas.__directCanvasId__,f,e.tagName,0,0,e.width,e.height,t,n,r,i)}};CanvasRenderingContext2D.prototype.translate=function(e,t){DirectCanvasSync.translate(this.canvas.__directCanvasId__,e,t)};CanvasRenderingContext2D.prototype.scale=function(e,t){DirectCanvasSync.scale(this.canvas.__directCanvasId__,e,t)};CanvasRenderingContext2D.prototype.transform=function(e,t,n,r,i,s){DirectCanvasSync.transform(this.canvas.__directCanvasId__,e,t,n,r,i,s)};CanvasRenderingContext2D.prototype.setTransform=function(e,t,n,r,i,s){DirectCanvasSync.setTransform(this.canvas.__directCanvasId__,e,t,n,r,i,s)};CanvasRenderingContext2D.prototype.resetTransform=function(){DirectCanvasSync.resetTransform(this.canvas.__directCanvasId__)};CanvasRenderingContext2D.prototype.rotate=function(e){DirectCanvasSync.rotate(this.canvas.__directCanvasId__,e)};CanvasRenderingContext2D.prototype.createLinearGradient=function(e,t,n,r){if(arguments.length>4)throw"not supported";return new f(e,t,n,r)};CanvasRenderingContext2D.prototype.createImageData=function(t,n){return new e(t,n)};CanvasRenderingContext2D.prototype.getImageData=function(t,r,i,s){canvasWidth=this.canvas.width*1;canvasHeight=this.canvas.height*1;if(t+i>canvasWidth){i=canvasWidth-t}if(r+s>canvasHeight){s=canvasHeight-r}if(i<=0||s<=0){throw new IndexSizeError}var o=new e(i,s);var u=DirectCanvasSync.getImageData(this.canvas.__directCanvasId__,t,r,i,s);o.data=n(u);return o};CanvasRenderingContext2D.prototype.putImageData=function(e,t,n,r,i,s,o){var u=e.data;var a=btoa(String.fromCharCode.apply(null,u));if(arguments.length==3){DirectCanvasSync.putImageData(this.canvas.__directCanvasId__,a,e.width,e.height,t,n,0,0,e.width,e.height)}else{if(s<0){r=r+s;s=s*-1}if(o<0){i=i+o;o=o*-1}if(r<0){s=s+r;r=0}if(i<0){o=o+i;i=0}if(s<=0||o<=0)return;DirectCanvasSync.putImageData(this.canvas.__directCanvasId__,a,e.width,e.height,t,n,r,i,s,o)}};window.directCanvasImageManager={imageCreationCount:0,imageList:[],addImageToList:function(e,t){directCanvasImageManager.imageList[e]=t},dispatchLoadEvent:function(e){var t=directCanvasImageManager.imageList[e];var n=document.createEvent("Events");n.initEvent("load",true,true);t.dispatchEvent(n)}};Image=function(e){return function(){var t=new e;var n=++directCanvasImageManager.imageCreationCount;t.imageId=n;directCanvasImageManager.addImageToList(n,t);DirectCanvasSync.createImage(n);t.__defineSetter__("src",function(e){DirectCanvasSync.setImageSrc(n,e);this._src=e});t.__defineGetter__("src",function(){return this._src});t.__defineGetter__("width",function(){return DirectCanvasSync.getImageWidth(n)});t.__defineGetter__("height",function(){return DirectCanvasSync.getImageHeight(n)});return t}}(Image);var d=window,v=[],m=null,g=true,y=function(e){this.clientX=e.clientX;this.clientY=e.clientY;this.pageX=e.pageX;this.pageY=e.pageY;this.screenX=e.screenX;this.screenY=e.screenY;if(e.identifier)this.identifier=e.identifier;else this.identifier=0;if(e.target)this.target=e.target;else this.target=d.document.elementFromPoint(this.pageX,this.pageY)};b.prototype.item=function(t){return this[t]};var w={currentTouch:null,knowsTouchAPI:null,mapPolyfillToTouch:{down:"touchstart",move:"touchmove",up:"touchend",cancel:"touchcancel"},checkTouchDevice:function(){try{var e=document.createEvent("TouchEvent");return typeof e.initTouchEvent==="function"&&typeof d.document.createTouchList==="function"}catch(t){return false}},checkMouseDevice:function(){try{document.createEvent("MouseEvent");return true}catch(e){return false}},polyfill:function(e){var t=w._getTouchesFromPolyfillData(e);m=t[0];for(action in e){if(action=="move"){for(i in t)w._updateTouchMap(t[i])}else{if(action=="down")w._updateTouchMap(m);else if(action=="up"||action=="cancel")w._removeFromTouchMap(m)}}w._raiseTouch(m,w.mapPolyfillToTouch[action]);return true},nativeTouchListener:function(e){if(e.isPolyfilled){return}m=w._getTouchFromEvent(e.changedTouches[0]);if(e.type=="touchmove"||e.type=="touchstart"){w._updateTouchMap(m)}else if(e.type=="touchend"||e.type=="touchcancel"){w._removeFromTouchMap(m)}},_raiseTouch:function(e,t){var n=e,r=e.target,i=this.getCleanedTouchMap(t);if(!r){r=d.document.elementFromPoint(e.clientX,e.clientY)}if(!r.__directCanvasId__){return}if(true==false){n=d.document.createEvent("TouchEvent");n.initTouchEvent(this._callCreateTouchList(i),this._callCreateTouchList(this.getTargetTouches(e.target)),this._callCreateTouchList([m]),t,d,e.screenX,e.screenY,e.clientX,e.clientY,false,false,false,false)}else{n=d.document.createEvent("Event");n.initEvent(t,true,true,document.body,0);n.changedTouches=new b([m]);n.touches=new b(i);n.targetTouches=new b(this.getTargetTouches(e.target));this._fillUpEventData(n);n.altKey=false;n.ctrlKey=false;n.metaKey=false;n.shiftKey=false;n.isPolyfilled=true}if(r)r.dispatchEvent(n);else document.dispatchEvent(n)},_getTouchesFromPolyfillData:function(e){var t=[],n,r;for(action in e){if(action=="move"){for(n=0;n<e[action].length;n++){for(touchId in e[action][n]){r={identifier:parseInt(touchId),clientX:e[action][n][touchId][0]/window.devicePixelRatio,clientY:e[action][n][touchId][1]/window.devicePixelRatio};this._fillUpEventData(r);t.push(w._getTouchFromEvent(r))}}}else{r={};if(action=="down"){for(touchId in e[action]){r.identifier=parseInt(touchId);r.clientX=e[action][touchId][0]/window.devicePixelRatio;r.clientY=e[action][touchId][1]/window.devicePixelRatio}}else if(action=="up"||action=="cancel"){r.identifier=parseInt(e[action]);r.clientX=m.clientX/window.devicePixelRatio;r.clientY=m.clientY/window.devicePixelRatio}this._fillUpEventData(r);t.push(w._getTouchFromEvent(r))}}return t},_fillUpEventData:function(e){if(!v[e.identifier])e.target=d.document.elementFromPoint(e.clientX,e.clientY);else e.target=v[e.identifier].target;e.screenX=e.clientX;e.screenY=e.clientY;e.pageX=e.clientX+d.pageXOffset;e.pageY=e.clientY+d.pageYOffset;return e},_getTouchFromEvent:function(e){if(this.knowsTouchAPI){return d.document.createTouch(d,e.target,e.identifier?e.identifier:0,e.pageX,e.pageY,e.screenX,e.screenY)}else return new y(e)},getTouchList:function(e){if(this.knowsTouchAPI)return this._callCreateTouchList(cleanedArray);return new b(e)},getCleanedTouchMap:function(e){var t,n=[];for(t=0;t<v.length;t++){if(v[t])n.push(v[t])}return n},_updateTouchMap:function(e){v[e.identifier]=e},_removeFromTouchMap:function(e){delete v[e.identifier]},_callCreateTouchList:function(e){switch(e.length){case 1:return d.document.createTouchList(e[0]);case 2:return d.document.createTouchList(e[0],e[1]);case 3:return d.document.createTouchList(e[0],e[1],e[2]);case 4:return d.document.createTouchList(e[0],e[1],e[2],e[3]);case 5:return d.document.createTouchList(e[0],e[1],e[2],e[3],e[4]);default:return d.document.createTouchList()}},getTargetTouches:function(e){var t,n,r=[];for(t=0;t<v.length;t++){if((n=v[t])&&n.target==e){r.push(n)}}return r},registerNativeTouchListener:function(e){var t=e&&!g?"removeEventListener":!e&&g?"addEventListener":false;if(t){d.document[t]("touchstart",w.nativeTouchListener,true);d.document[t]("touchend",w.nativeTouchListener,true);d.document[t]("touchcancel",w.nativeTouchListener,true);d.document[t]("touchmove",w.nativeTouchListener,true)}g=e}};w.knowsTouchAPI=w.checkTouchDevice();d.WMP={polyfill:w.polyfill,setPolyfillAllTouches:w.registerNativeTouchListener,Version:"0.3"}})()