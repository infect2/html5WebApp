define("pwge/board",["pwge/boardManager","pwge/util"],function(a,b){var c=function(a,c){this.name=a,this.x=0,this.y=0,this.z=0,this.dirty=!0,this.entities=[],this.enabled=!1,this.paused=!0,this.startedTime=0,this.pausedTime=0,this.past=0,this._timeline=[],this._lastStep={};var d,e;for(d=0,e=this._stepProps.length;e>d;d++)this._lastStep[this._stepProps[d]]=void 0;c&&b.extend(this,c)};return c.prototype._stepProps=["x","y","z"],c.prototype._setLastStep=function(){var a,b;for(a=0,b=this._stepProps.length;b>a;a++)this._lastStep[this._stepProps[a]]=this[this._stepProps[a]]},c.prototype._checkDirty=function(){var a;for(a in this._lastStep)if(this._lastStep[a]!==this[a])return void(this.dirty=!0)},c.prototype.addEntity=function(a){var c=this;return this.findEntity(a)||(this.entities.push(a),a.owner=this,this.dirty=!0,this._boardManager._owner.runtime.defineProperty&&(a._z=a.z,delete a.z,Object.defineProperty(a,"z",{configurable:!0,get:function(){return this._z},set:function(a){this._z!==a&&(this._z=a,this.owner&&(c._orderedEntities=b.sortByZ(c.entities)))}}),c._orderedEntities=b.sortByZ(c.entities))),this},c.prototype.findEntity=function(a){var b,c,d,e,f;switch(typeof a){case"string":b=a;break;case"function":c=a;break;case"object":b=a.id}if(b){for(e=0,f=this.entities.length;f>e;e++)if(this.entities[e]&&this.entities[e].id===b)return this.entities[e];return null}if(c){for(d=[],e=0,f=this.entities.length;f>e;e++)this.entities[e]&&c.call(this.entities[e],this.entities[e])&&d.push(this.entities[e]);return 1===d.length?d[0]:d.length?d:null}},c.prototype.detect=function(a,c){for(var d={x:a,y:c,width:2,height:2,anchorX:1,anchorY:1},e=0,f=this.entities.length;f>e;e++)if(this.entities[e]&&this.entities[e].detectable&&b.overlap(d,this._getAbsoluteCanvasPosition(this.entities[e])))return this.entities[e];return null},c.prototype._getAbsoluteCanvasPosition=function(a){var b=this._boardManager._owner.viewport.renderRatio;return{x:(this.x+a.x)*b,y:(this.y+a.y)*b,width:a.width*b,height:a.height*b,anchorX:a.anchorX*b,anchorY:a.anchorY*b}},c.prototype.removeEntity=function(a){return a=this.findEntity(a),a&&(a.owner=null,this.entities.splice(this.entities.indexOf(a),1),this.dirty=!0),this},c.prototype.enable=function(){return this.enabled||(this.dirty=!0,this.resume(),this.enabled=!0),this},c.prototype.disable=function(){return this.enabled&&(this.dirty=!0,this.pause(),this.enabled=!1),this},c.prototype.pause=function(){return this.paused||(this.dirty=!0,this.paused=!0,this.pausedTime=this.past),this},c.prototype.resume=function(){return this.paused&&(this.dirty=!0,this.paused=!1,this.startedTime=this._boardManager._owner.renderer.now()-this.past),this},c.prototype.now=function(){return this.past},c.prototype.step=function(a){var b,c;for(this.paused?a=this.past:a-=this.startedTime,a=Math.max(0,a),this.past=a,this._doTask(a),b=0,c=this.entities.length;c>b;b++)this.entities[b]&&this._boardManager._owner.renderer.isRendering()&&this.enabled&&this.entities[b].enabled&&this.entities[b].step.call(this.entities[b],a)},c.prototype.draw=function(a){var b,c;for(this.paused?a=this.past:a-=this.startedTime,a=Math.max(0,a),this.past=a,b=0,c=this.entities.length;c>b;b++)this.entities[b]&&this._boardManager._owner.renderer.isRendering&&this.enabled&&this.entities[b]&&this.entities[b].owner===this&&this.entities[b].enabled&&(this.entities[b].draw(a),this.entities[b]._checkDirty())},c.prototype._flush=function(){var a,c,d;for(d=this._boardManager._owner.runtime.defineProperty&&this._orderedEntities?this._orderedEntities:b.sortByZ(this.entities),a=0,c=d.length;c>a;a++)this._boardManager._owner.renderer.isRendering&&this.enabled&&d[a]&&d[a].owner===this&&d[a].enabled&&d[a]._flush();this._setLastStep()},c.prototype.timeline=function(a){return this._timeline=a,this._done=[],this._done.length=this._timeline.length,this},c.prototype._doTask=function(a){for(var b=[],c=0;c<this._timeline.length;c++)this._timeline[c][0]<a&&!this._done[c]&&b.push(c);b.forEach(function(b){this._done[b]=!0,this._timeline[b][1].call(this,this._timeline[b][0],a)},this)},c.prototype.destroy=function(){this.entities.length=0,this._timeline.length=0,this._boardManager._boardPool.free(this)},c.prototype.getBoardManager=function(){return this._boardManager},c}),define("pwge/boardManager",["util/ObjectPool","pwge/board","pwge/util"],function(a,b){var c=function(c){this._boardPool=new a(b,c.config.boardPoolSize),this._boards=[]};return c.prototype.makeBoard=function(a,b){var c,d=this.getBoard(a);return b=b||{},d?(this._boardPool._ConstructorFunction.call(d,a,b),d):(c=this._boardPool.allocate(a,b),c._boardManager=this,this._boards.push(c),c)},c.prototype.getBoard=function(a){if("undefined"==typeof a)return this._boards;for(var b=0,c=this._boards.length;c>b;b++)if(this._boards[b].name===a)return this._boards[b];return null},c.prototype.removeBoard=function(a){for(var b,c=0,d=this._boards.length;d>c;c++)this._boards[c].name===a&&(b=this._boards[c],this._boards[c].splice(this._boards[c].indexOf(b),1),b.destroy(),this.dirty=!0);return this},c.prototype.findEntity=function(a){for(var b,c=[],d=0,e=this._boards.length;e>d;d++)b=this._boards[d].findEntity(a),b&&(Array.isArray(b)?c=c.concat(b):c.push(b));return c.length?c:null},c.prototype.detect=function(a,b){var c,d;for(d=0;d<this._boards.length;d++)if(this._boards[d].enabled&&(c=this._boards[d].detect(a,b)))return c;return null},c.prototype.enable=function(a){var b=this.getBoard(a);return b&&b.enable(),this},c.prototype.disable=function(a){var b=this.getBoard(a);return b&&b.disable(),this},c}),define("pwge/canvas",function(){var a=function(a){this.setElement(a.config.canvas)};return a.prototype.setElement=function(a){return"canvas"===a.tagName.toLowerCase()?(this.container=a.parentNode,this.element=a):(this.container=a,this.element=document.createElement("canvas"),a.appendChild(this.element)),this.ctx=a.getContext("2d"),this},a.prototype.resize=function(a,b,c){return"undefined"==typeof c&&(c=1),this._owner.viewport.canvasWidth=this.width=this.element.width=Math.round(a*c),this._owner.viewport.canvasHeight=this.height=this.element.height=Math.round(b*c),this._owner.runtime.planetWebview||(this.element.style.width=a+"px",this.element.style.height=b+"px"),this},a.prototype.clear=function(){return this.ctx.fillStyle="#fff",this.ctx.fillRect(0,0,this.width,this.height),this},a.prototype.offscreen=function(){var a=document.createElement("canvas");return a.width=this.width,a.height=this.height,a},a}),define("pwge/config",function(){var a={};return a.container=window,a.viewport="default",a.viewportAlign={horizontal:"center",vertical:"middle"},a.quality="low",a.maxQuality="low",a.planetWebview=!0,a.loaderTimeout=3e4,a.boardPoolSize=16,a.entityPoolSize=128,a.clearCanvasOnEveryFrame=!0,a.debug=!1,a}),define("pwge/debug",function(){var a=function(a){this.renderer=a.renderer;var b,c=[],d=0;this._callback=function(a){return b?(d=a-b,c.length>10&&c.splice(0,1),c.push(d),c.length>0&&d>0&&(this.fps.textContent=(1e3/(c.reduce(function(a,b){return a+b})/c.length)).toFixed(1)),void(b=a)):void(b=a)}.bind(this)};return a.prototype.getFPSElement=function(){return this.fps||(this.fps=document.createElement("span")),this.fps},a.prototype.start=function(){var a=this.getFPSElement();return this.fps.textContent="FPS METER",document.body.appendChild(a),a.style.cssText="position:absolute;bottom:0;right:0;color:#fff;font-size:18px;margin:0;padding:5px;background:#000;opacity:0.75;font-family:Arial;font-weight:bold",this.renderer.on("draw",this._callback),this},a.prototype.stop=function(){return document.body.removeChild(this.fps),this.renderer.off("draw",this._callback),this},a}),define("pwge/entity",["pwge/spriteManager","pwge/util","util/PubSub","util/easing"],function(a,b,c,d){var e=function(a){this.id=b.generateId(),this.owner=null,this.enabled=!0,this.baseImage=null,this.baseSprite=null,this.animation=null,this.animationStart=0,this.animationEnd=0,this.sprite=null,this.spriteStart=0,this.spriteEnd=0,this.detectable=!0,this.opacity=1,this.anchorX=0,this.anchorY=0,this.rotate=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,this.z=0,this._z=0,this.width=0,this.height=0,a&&b.extend(this,a),this._init()};return e.prototype=Object.create(c.prototype),e.prototype._drawProps=["image","sx","sy","sw","sh","dx","dy","dw","dh"],e.prototype._stepProps=["owner","enabled","x","y","z","opacity","anchorX","anchorY","rotate","scaleX","scaleY","width","height"],e.prototype._setLastStep=function(){var a,b;for(a=0,b=this._stepProps.length;b>a;a++)this._lastStep[this._stepProps[a]]=this[this._stepProps[a]]},e.prototype._setLastDraw=function(){var a,b;for(a=0,b=this._drawProps.length;b>a;a++)this._lastDraw[this._drawProps[a]]=this._drawImageData[this._drawProps[a]]},e.prototype._init=function(){var a,b;for(this._drawImageData||(this._drawImageData={}),this._lastStep||(this._lastStep={}),this._lastDraw||(this._lastDraw={}),a=0,b=this._stepProps.length;b>a;a++)this._lastStep[this._stepProps[a]]=void 0;for(a=0,b=this._drawProps.length;b>a;a++)this._drawImageData[this._drawProps[a]]=void 0,this._lastDraw[this._drawProps[a]]=void 0},e.prototype._checkDirty=function(){var a;for(a in this._lastStep)if(this._lastStep[a]!==this[a]&&this.owner)return void(this.owner.dirty=!0);for(a in this._lastDraw)if(this._lastDraw[a]!==this._drawImageData[a]&&this.owner)return void(this.owner.dirty=!0)},e.prototype.step=function(a){if(this.animation&&(a>=this.animationStart&&this.animation.step.call(this,a),a>this.animationEnd)){var b;"function"==typeof this.animation.callback&&(b=this.animation.callback),this.animation=null,b&&b.call(this)}},e.prototype.draw=function(a){if(this.sprite){var b=a-this.spriteStart,c=(this.sprite.options.duration+this.sprite.options.sleep)*this.sprite.options.repeat;this.sprite&&this.baseImage&&b>c?(this.sprite=null,this.drawImage(this.baseImage,0,0,this.baseImage.width,this.baseImage.height,this.owner.x+this.x,this.owner.y+this.y,this.width,this.height)):(this.baseSprite&&this.sprite.name!==this.baseSprite.name&&!this.sprite.options.loop&&b>c&&this.applySprite(this.baseSprite.name),this.sprite.draw.call(this,b))}else this.baseImage&&this.drawImage(this.baseImage,0,0,this.baseImage.width,this.baseImage.height,this.owner.x+this.x,this.owner.y+this.y,this.width,this.height)},e.prototype.drawImage=function(a,b,c,d,e,f,g,h,i){var j=this._objectPool._owner.viewport,k=j.renderRatio;this._drawImageData.image=a,this._drawImageData.sx=b,this._drawImageData.sy=c,this._drawImageData.sw=d,this._drawImageData.sh=e,this._drawImageData.dx=(f-this.anchorX)*k,this._drawImageData.dy=(g-this.anchorY)*k,this._drawImageData.dw=h*k,this._drawImageData.dh=i*k,this._drawImageData.sx+this._drawImageData.sw>a.width&&(this._drawImageData.sw=a.width-this._drawImageData.sx),this._drawImageData.sy+this._drawImageData.sh>a.height&&(this._drawImageData.sh=a.height-this._drawImageData.sy)},e.prototype._flush=function(){this._setLastStep();var a=this._drawImageData,b=this._objectPool._owner.viewport.renderRatio,c=(this.owner.x+this.x)*b,d=(this.owner.y+this.y)*b,e=this._objectPool._owner.canvas,f=!1;a.image&&a.sw>0&&a.sh>0&&((1!==this.opacity||this.rotate||1!==this.scaleX||1!==this.scaleY)&&(e.ctx.save(),f=!0),1!==this.opacity&&(e.ctx.globalAlpha=this.opacity),(this.rotate||1!==this.scaleX||1!==this.scaleY)&&(e.ctx.translate(c,d),e.ctx.rotate(this.rotate),e.ctx.scale(this.scaleX,this.scaleY),e.ctx.translate(-c,-d)),e.ctx.drawImage(a.image,a.sx,a.sy,a.sw,a.sh,a.dx,a.dy,a.dw,a.dh),f&&e.ctx.restore(),this._setLastDraw())},e.prototype.addTo=function(a){return this._objectPool._owner.boardManager.getBoard(a).addEntity(this),this},e.prototype.enable=function(){return this.enabled=!0,this},e.prototype.disable=function(){return this.enabled=!1,this},e.prototype.scale=function(a){return this.width*=a,this.height*=a,this},e.prototype.getOwnerBoard=function(){return this.owner},e.prototype.setBaseSprite=function(b,c){return c=c||0,this.baseSprite=a.get(b),this.sprite&&this.sprite.name===b||this.applySprite.call(this,b,c),this},e.prototype.setBaseImage=function(a){return this.baseImage=a,this},e.prototype.applySprite=function(b,c){return this.sprite=a.get(b),this.sprite&&(this.spriteStart="undefined"!=typeof c?c:this.owner?this.owner.now():0,this.spriteEnd=this.spriteStart+this.sprite.options.duration+this.sprite.options.sleep,this.sprite.options.loop&&(this.spriteEnd=1/0)),this},e.prototype.animate=function(a,b){return this.animation=a,this.animation.step=this._makeAnimationStepFunction(a),this.animationStart=b||(this.owner?this.owner.now():0),this.animationEnd=this.animationStart+this.animation.duration,this.owner&&this.step.call(this,this.owner.now()),this},e.prototype._makeAnimationStepFunction=function(a){var b=a.from,c=a.to;return function(e){var f,g=e-this.animationStart;for(f in b)this[f]=b[f]+d[a.easing[f]](g,0,c[f]-b[f],a.duration)}},e.prototype.destroy=function(){this.owner&&this.owner.removeEntity(this),this._objectPool.free(this)},e}),define("pwge/game",["pwge/runtime","pwge/config","pwge/canvas","pwge/input","pwge/loader","pwge/spriteManager","pwge/soundManager","pwge/boardManager","pwge/renderer","pwge/entity","pwge/util","util/PubSub","util/ObjectPool"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=function(l){this.viewport={},this._importModule("runtime",a),this._importModule("config",b),k.extend(this.config,l),this._importModule("canvas",new c(this)),this._importModule("renderer",new i(this)),this._importModule("boardManager",new h(this)),this._importModule("entityPool",new m(j,b.entityPoolSize)),this._importModule("loader",e),this._importModule("spriteManager",f),this._importModule("input",new d(this)),this._importModule("soundManager",g),this.config.debug&&require(["pwge/debug"],function(a){this._importModule("debug",new a(this)),this.debug.start()}.bind(this)),this._setContainer(this.config.container),this._setDesignResolution.apply(this,[this.config.resolution.width,this.config.resolution.height,this.config.resolution.quality]||[this.canvas.element.width,this.canvas.element.height,"low"]),this._setViewport(this.config.viewport,this.config.viewportAlign),this.config.resource&&this.loader.loadResources(this.config.resource).then(function(){this.trigger("ready")}.bind(this))};return n.prototype=Object.create(l.prototype),n.prototype._setDesignResolution=function(a,b,c){var d={low:1,mid:2,high:3};switch(this.viewport.quality=this.config.quality,this.viewport.designQuality=c,this.viewport.designWidth=a,this.viewport.designHeight=b,this.viewport.designQuality){case"mid":a=Math.round(a/2),b=Math.round(b/2);break;case"high":a=Math.round(a/3),b=Math.round(b/3)}switch(this.viewport.width=a,this.viewport.height=b,this.viewport.quality){case"auto":this.viewport.pixelRatio=Math.min(d[this.config.maxQuality],this.runtime.pixelRatio*Math.round(this.viewport.containerWidth/a));break;case"low":this.viewport.pixelRatio=1;break;case"mid":this.viewport.pixelRatio=2;break;case"high":this.viewport.pixelRatio=3}return this.viewport.imageRatio=Math.floor(this.viewport.pixelRatio)/3,this.runtime.planetWebview&&(this.viewport.pixelRatio=this.viewport.containerWidth/a),console.log(this,this.viewport),this},n.prototype._setContainer=function(a){return this.container=a,a===window?(this.viewport.containerWidth=window.innerWidth,this.viewport.containerHeight=window.innerHeight):(this.viewport.containerWidth=a.offsetWidth,this.viewport.containerHeight=a.offsetHeight),this},n.prototype._setViewport=function(a,b){var c,d,e=this.viewport.width,f=this.viewport.height,g=this.viewport.containerWidth,h=this.viewport.containerHeight,i=g/e,j=h/f;switch(a){case"default":break;case"scale_to_fit":g/h>e/f?(e*=j,f=h):(e=g,f*=i);break;case"stretch_to_fit":e=g,f=h;break;case"scale_to_fit_width":e=g,f*=i;break;case"scale_to_fit_height":e*=j,f=h}switch(this.canvas.resize(e,f,this.viewport.pixelRatio),this.viewport.renderRatio=this.viewport.canvasWidth/this.viewport.designWidth,b.vertical){default:case"top":d=0;break;case"middle":d=Math.round((h-f)/2);break;case"bottom":d=h-f}switch(b.horizontal){default:case"left":c=0;break;case"center":c=Math.round((g-e)/2);break;case"right":c=g-e}return this.runtime.planetWebview?(this.viewport.width=this.viewport.canvasWidth,this.viewport.height=this.viewport.canvasHeight,this.viewport.ratioWidth=1,this.viewport.ratioHeight=1):(this.canvas.element.style.marginLeft=c+"px",this.canvas.element.style.marginTop=d+"px",this.viewport.width=e,this.viewport.height=f,this.viewport.ratioWidth=i,this.viewport.ratioHeight=j),this},n.prototype._importModule=function(a,b){this[a]=b,this[a]._owner=this},n}),define("pwge/input",["util/PubSub"],function(a){var b=function(a){this.setup(a.canvas.element)};return b.prototype=Object.create(a.prototype),b.prototype._delegate=function(a,b){var c,d,e,f=this._owner;f&&f.renderer.isRendering()&&(a.stopPropagation(),a.preventDefault(),"boolean"==typeof b&&(c=b?a.changedTouches[0].clientX-f.canvas.element.offsetLeft+window.scrollX:a.offsetX,d=b?a.changedTouches[0].clientY-f.canvas.element.offsetTop+window.scrollY:a.offsetY,a.ratioX=c/f.viewport.width,a.ratioY=d/f.viewport.height,a.canvasX=a.ratioX*f.viewport.canvasWidth,a.canvasY=a.ratioY*f.viewport.canvasHeight,a.designX=a.ratioX*f.viewport.designWidth,a.designY=a.ratioY*f.viewport.designHeight),this.trigger(a.type,a),(e=f.boardManager.detect(a.canvasX,a.canvasY))&&e.owner&&e.trigger(a.type,a))},b.prototype.setup=function(a){var b=this;a.addEventListener("touchstart",function(a){b._delegate(a,!0)},!0),a.addEventListener("touchmove",function(a){b._delegate(a,!0)},!0),a.addEventListener("touchend",function(a){b._delegate(a,!0)},!0),a.addEventListener("touchcancel",function(a){b._delegate(a,!0)},!0),a.addEventListener("dblclick",function(a){b._delegate(a,!1)},!0),a.addEventListener("click",function(a){b._delegate(a,!1)},!0),a.addEventListener("mousedown",function(a){b._delegate(a,!1)},!0),a.addEventListener("mousemove",function(a){b._delegate(a,!1)},!0),a.addEventListener("mouseup",function(a){b._delegate(a,!1)},!0)},b}),define("pwge/loader",["pwge/runtime","pwge/soundManager","pwge/util"],function(a,b,c){var d={},e={},f=function(a){return new Promise(function(b,c){{var d=new Image;setTimeout(function(){c(Error("can't load "+a))},e._owner.config.loaderTimeout)}d.onload=function(){b(d)},d.src=a})},g=function(b){return new Promise(function(c,d){a.HTMLAudioElement&&a.AudioContext||c(void 0);{var f=new Audio;setTimeout(function(){d(Error("can't load "+b))},e._owner.config.loaderTimeout)}f.addEventListener("canplaythrough",function(){c(f)}),f.src=b})},h=function(c){return new Promise(function(d,e){a.AudioContext||d(void 0);var f,g=new XMLHttpRequest;g.open("GET",c,!0),g.responseType="arraybuffer",g.onload=function(){f=window.SKPWebView?new a.AudioContext:b.audioContext,f.decodeAudioData(g.response,function(a){d(a)},function(){e(Error("decode error"))})},g.onerror=function(){e(Error("XHR error"))},g.send()})};return e.loadImages=function(a){var b={};return Promise.all(Object.keys(a).map(function(c){var e=a[c];return f(a[c]).then(function(a){return b[c]=d[encodeURIComponent(e)]=a,b})})).then(function(){return arguments[0][0]})},e.loadMusics=function(a){var b={};return Promise.all(Object.keys(a).map(function(c){var e=a[c];return g(e).then(function(a){return a&&(b[c]=d[encodeURIComponent(e)]=a),b})})).then(function(){return arguments[0][0]})},e.loadSounds=function(a){var b={};return Promise.all(Object.keys(a).map(function(c){var e=a[c];return h(e).then(function(a){return b[c]=d[encodeURIComponent(e)]=a,b})})).then(function(){return arguments[0][0]})},e.loadResources=function(a){var b,d=[],f=a.images,g="low/";if(a.imagePath){e._owner.viewport.imageRatio===2/3&&(g="mid/"),1===e._owner.viewport.imageRatio&&(g="high/");for(b in f)f[b]=a.imagePath+g+f[b]}return"undefined"!=typeof a.images&&d.push(e.loadImages(f).then(function(b){var c;a.spriteInfo&&(c=Object.keys(a.spriteInfo),c.forEach(function(c){e._owner.spriteManager.set(c,b[a.spriteInfo[c].image],a.spriteInfo[c])})),Object.keys(b).forEach(function(d){c.some(function(b){return a.spriteInfo[b].image===d})||e._owner.spriteManager.set(d,b[d])})})),"undefined"!=typeof a.musics&&(/iphone|ipad|ipod/i.test(window.navigator.userAgent)?(a.sounds=c.extend(a.sounds||{},a.musics),a.musicInfo&&(a.soundInfo=c.extend(a.soundInfo||{},a.musicInfo))):d.push(e.loadMusics(a.musics).then(function(b){Object.keys(b).forEach(function(c){a.musicInfo&&a.musicInfo[c]?e._owner.soundManager.setMusic(c,b[c],a.musicInfo[c]):e._owner.soundManager.setMusic(c,b[c])})}))),"undefined"!=typeof a.sounds&&d.push(e.loadSounds(a.sounds).then(function(b){Object.keys(b).forEach(function(c){a.soundInfo&&a.soundInfo[c]?e._owner.soundManager.setSound(c,b[c],a.soundInfo[c]):e._owner.soundManager.setSound(c,b[c])})})),Promise.all(d)},e.get=function(a){return d[encodeURIComponent(a)]||null},/iphone|ipad|ipod/i.test(window.navigator.userAgent)&&(e.loadMusics=e.loadSounds,e.loadMusic=e.loadSound),e}),define("pwge/renderer/transition",["util/easing"],function(a){return{fade:function(b,c){var d=this.canvas,e=a[c.easing](b,0,1,c.duration);this.save(),this.drawImage(c.from,0,0,d.width,d.height),this.globalAlpha=e,this.drawImage(c.to,0,0,d.width,d.height),this.restore()},zoomIn:function(b,c){var d=this.canvas,e=a[c.easing](b,0,1,c.duration);this.save(),this.translate(-d.width/2*e+d.width/2,-d.height/2*e+d.height/2),this.scale(e,e),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},zoomOut:function(b,c){var d=this.canvas,e=4-a[c.easing](b,0,3,c.duration);this.save(),this.translate(-d.width/2*e+d.width/2,-d.height/2*e+d.height/2),this.scale(e,e),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},slideInRight:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.width,c.duration));this.save(),this.translate(-e,0),this.drawImage(c.from,0,0,d.width,d.height),this.translate(d.width,0),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},slideInLeft:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.width,c.duration));this.save(),this.translate(e,0),this.drawImage(c.from,0,0,d.width,d.height),this.translate(-d.width,0),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},slideInBottom:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.height,c.duration));this.save(),this.translate(0,-e),this.drawImage(c.from,0,0,d.width,d.height),this.translate(0,d.height),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},slideInTop:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.height,c.duration));this.save(),this.translate(0,e),this.drawImage(c.from,0,0,d.width,d.height),this.translate(0,-d.height),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},moveInRight:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.width,c.duration));this.save(),this.drawImage(c.from,0,0,d.width,d.height),this.translate(d.width-e,0),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},moveInLeft:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.width,c.duration));this.save(),this.drawImage(c.from,0,0,d.width,d.height),this.translate(-d.width+e,0),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},moveInBottom:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.height,c.duration));this.save(),this.drawImage(c.from,0,0,d.width,d.height),this.translate(0,d.height-e),this.drawImage(c.to,0,0,d.width,d.height),this.restore()},moveInTop:function(b,c){var d=this.canvas,e=Math.round(a[c.easing](b,0,d.height,c.duration));this.save(),this.drawImage(c.from,0,0,d.width,d.height),this.translate(0,e-d.height),this.drawImage(c.to,0,0,d.width,d.height),this.restore()}}}),define("pwge/renderer",["util/PubSub","pwge/util","pwge/renderer/transition"],function(a,b,c){var d=function(){this._raf=null,this._rafBody=function(){return this._stopRequested?(this._isRendering=!1,this._stopRequested=!1,void this.trigger("stop")):void this._loop()}.bind(this),this._now=0,this._lastTick=0,this._timeGap=0,this._scene={},this._currentScene=null,this._isRendering=!1,this._startedTime=0,this._pausedTime=0,this.on("step",function(a){var b,c,d=this._owner.boardManager.getBoard();for(b=0,c=d.length;c>b;b++)d[b]&&this.isRendering()&&d[b].enabled&&(d[b].b2World?d[b].b2World.Step(a):d[b].step(a))}),this.on("draw",function(a){var c,d,e,f=!1,g=this._owner.canvas,h=this._owner.boardManager.getBoard();for(c=0,d=h.length;d>c;c++)h[c]&&this.isRendering()&&h[c].enabled&&(h[c].draw(a),h[c]._checkDirty());for(c=0,d=h.length;d>c;c++)if(this.isRendering()&&h[c].enabled&&h[c].dirty){f=!0;break}if(f){for(this._owner.config.clearCanvasOnEveryFrame&&g.clear(),e=b.sortByZ(h),c=0,d=e.length;d>c;c++)e[c]&&this.isRendering()&&e[c].enabled&&(e[c]._flush(),e[c].dirty=!1);this._owner.runtime.planetWebview&&g.ctx.canvas===g.element&&g.ctx.flush()}}),this.on("switchScene",function(a,c){var d=this._owner.boardManager.getBoard();if("undefined"!=typeof c){var e,f;e=this.snapShot(),d.forEach(function(b){a.indexOf(b.name)>-1?b.enable():b.disable()}),f=this.snapShot(),d.forEach(function(a){a.disable()}),this._transition(b.extend(c,{from:e,to:f,callback:function(){d.forEach(function(b){a.indexOf(b.name)>-1?b.enable():b.disable()})}}))}else d.forEach(function(b){a.indexOf(b.name)>-1?b.enable():b.disable()})}),this.on("stop",function(){var a=this._owner.boardManager.getBoard();a.forEach(function(a){"undefined"!=typeof a._done&&(a._done=a._done.map(function(){return!1})),a.entities.forEach(function(a){a._init()}),a.startedTime=0,a.pausedTime=0,a.past=0}),this._owner.canvas.clear(),this._currentScene=null})};return d.prototype=Object.create(a.prototype),d.prototype._loop=function(){var a=+new Date;this._raf=requestAnimationFrame(this._rafBody),a<this._lastTick&&(this._timeGap+=a-this._lastTick,this.trigger("log",this._timeGap)),this._now=a-this._startedTime+this._pausedTime-this._timeGap,this.render(this._now),this._lastTick=a},d.prototype.render=function(a){return this._isRendering&&(this.trigger("step",a),this.trigger("draw",a)),this},d.prototype.start=function(){return this._isRendering||(this._startedTime=+new Date,this._lastTick=0,this._timeGap=0,this._isRendering=!0,this._loop()),this},d.prototype.resume=d.prototype.start,d.prototype.pause=function(){return this._pausedTime=this._now,this._stopRequested=!0,this},d.prototype.stop=function(){return this._startedTime=0,this._pausedTime=0,this._now=0,this._stopRequested=!0,this},d.prototype.now=function(){return this._now},d.prototype.isRendering=function(){return this._isRendering},d.prototype.makeScene=function(a,b){return this._scene[a]=Array.isArray(b)?b:[b],this},d.prototype.switchScene=function(a,b){var c=this._scene[a];return c&&(this._currentScene=a,"undefined"==typeof b?this.trigger("switchScene",c):("string"==typeof b&&(b={type:b}),this.trigger("switchScene",c,b))),this},d.prototype.getCurrentScene=function(){return this._currentScene},d.prototype.snapShot=function(){var a=this._owner.canvas,b=a.ctx,c=a.offscreen();return a.ctx=c.getContext("2d"),a.ctx.drawImage(a.element,0,0,a.width,a.height),this.render(this._now),a.ctx=b,c},d.prototype._transition=function(a){this.pause(),a=b.extend({duration:500,easing:"linear",start:+new Date},a);var d=this._owner.canvas,e=this._owner.runtime,f=function(){d.clear();var b=+new Date-a.start;b<=a.duration?(c[a.type].call(d.ctx,b,a),e.planetWebview&&d.ctx.canvas===d.element&&d.ctx.flush(),requestAnimationFrame(f)):(d.ctx.drawImage(a.to,0,0,d.width,d.height),"function"==typeof a.callback&&a.callback(),this.resume())}.bind(this);f()},d}),define("pwge/runtime",function(){var a={};(function(a){var b=a.getContext("2d"),c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1;this.devicePixelRatio=c,this.backingStorePixelRatio=d,this.pixelRatio=c/d,this.planetWebview="function"==typeof b.flush}).call(a,document.createElement("canvas")),a.defineProperty="function"==typeof Object.defineProperty,a.HTMLAudioElement=window.HTMLAudioElement||!1;var b=window.AudioContext||window.webkitAudioContext||!1;return a.AudioContext=b&&"function"==typeof(new b).createGain?b:!1,/Android/.test(window.navigator.userAgent)&&(a.AudioContext=window.AudioContext||!1),a}),define("pwge/soundManager",["pwge/runtime","pwge/util"],function(a,b){var c={},d={},e={},f={},g={},h={},i=c.audioElement=a.HTMLAudioElement?document.createElement("audio"):void 0,j=c.audioContext=a.AudioContext?new a.AudioContext:void 0;return c.setMusic=function(a,c,f){return d[a]=c,e[a]=b.extend({loop:!1,volume:1},f||{}),this},c.getMusic=function(a){return d[a]},c.playMusic=function(a,c){var d=this.getMusic(a);return i&&d&&(c=b.extend(e[a],c||{}),this.stopMusic(),i.volume=c.volume,i.loop=c.loop,i.src=d.src,i.play(0)),this},c.stopMusic=function(){return i&&i.pause(),this},c.setSound=function(a,c,d){return f[a]=c,g[a]=b.extend({loop:!1,volume:1},d||{}),this},c.getSound=function(a){return f[a]},c.playSound=function(a,c){var d=this.getSound(a);if(j&&d){c=b.extend(g[a]||{},c||{}),this.stopSound(a);var e=h[a]=j.createBufferSource();e.buffer=d,e.loop=c.loop;var f=j.createGain();e.connect(f),f.connect(j.destination),f.gain.value=c.volume,e.start(0)}return this},c.stopSound=function(a){return h[a]&&(h[a].stop(0),h[a]=null),this},/iphone|ipad|ipod/i.test(window.navigator.userAgent)&&(c.playMusic=c.playSound,c.stopMusic=c.stopSound),c}),define("pwge/spriteManager",["pwge/canvas","util/easing","pwge/util"],function(a,b,c){var d,e={},f={};return d=function(a,b,d){var e;if(this.name=a,this.image=b,this.options=c.extend({loop:!1,repeat:1,duration:0,sleep:0,order:[],easing:"linear"},d),this.x=this.options.x,this.y=this.options.y,this.width=this.options.width,this.height=this.options.height,this.lastAwake=0,!this.options.order.length)for(e=0;e<this.options.frames;e++)this.options.order.push(e);this.uniqueFrames=[],this.options.order.forEach(function(a){this.options.order.indexOf(a)>-1&&this.uniqueFrames.indexOf(a)<0&&this.uniqueFrames.push(a)},this)},d.prototype.draw=function(a){var b=this.sprite.image,c=this.sprite.x+this.sprite._getCurrentFrame(a)*this.sprite.width,d=this.sprite.y,e=Math.min(this.sprite.options.width,this.sprite.width),f=Math.min(this.sprite.options.height,this.sprite.height),g=this.owner.x+this.x,h=this.owner.y+this.y,i=this.width,j=this.height;this.drawImage(b,c,d,e,f,g,h,i,j)},d.prototype.getFrameAsImage=function(b){var c=a.offscreen().getContext("2d");return c.drawImage(this.image,this.x+this.width*b,this.y,this.width,this.height,this.x,this.y,this.width,this.height),c.canvas},d.prototype._getCurrentFrame=function(a){return 1===this.options.frames?0:(a=Math.max(0,a),!this.options.loop&&a>(this.options.duration+this.options.sleep)*this.options.repeat?this.options.order[this.options.order.length-1]:this.options.order[Math.min(this.options.order.length-1,Math.floor(b[this.options.easing](a%(this.options.duration+this.options.sleep),0,this.options.order.length,this.options.duration)))])},f.get=function(a){return e[a]},f.set=function(a,b,c){return"undefined"!=typeof c?["x","y","width","height"].forEach(function(a){c[a]=c[a]*this._owner.viewport.imageRatio},this):c={x:0,y:0,width:b.width,height:b.height,frames:1},e[a]=new d(a,b,c),this},f}),define("pwge/util",function(){var a,b={};return a=function(b){var c,d={};for(c in b)b.hasOwnProperty(c)&&(d[c]="[object Object]"===Object.prototype.toString.call(b[c])?a(b[c]):b[c]);return d},b.extend=function(){for(var c,d,e=arguments[0],f=1;f<arguments.length;f++){c=arguments[f];for(d in c)c.hasOwnProperty(d)&&(e[d]="[object Object]"===Object.prototype.toString.call(c[d])&&e.hasOwnProperty(d)?b.extend(e[d],a(c[d])):c[d])}return e},b.generateId=function(){return Math.round(1e5*Math.random()).toString()+(+new Date).toString()},b.overlap=function(a,b){return a.x<=b.x+b.width&&a.y<=b.y+b.height&&b.x<=a.x+a.width&&b.y<=a.y+a.height},b.getOffset=function(a){var b={top:0,left:0},c=document.documentElement;return"undefined"!=typeof a.getBoundingClientRect&&(b=a.getBoundingClientRect()),{top:b.top+window.pageYOffset-c.clientTop,left:b.left+window.pageXOffset-c.clientLeft}
},b.sortByZ=function(a){var b,c,d,e=[],f={},g=a.length;for(d=0;g>d;d++)b=a[d].z.toString(),f[b]||(f[b]=[]),f[b].push(a[d]);for(c=Object.keys(f).sort(function(a,b){return 1*a>1*b?1:-1}),d=0,g=c.length;g>d;d++)e=e.concat(f[c[d].toString()]);return e},b}),define("util/ObjectPool",function(){var a=function(a,b){this._ConstructorFunction=a,this.metrics={},this._clearMetrics(),this._objpool=[],b&&b>0&&this.expand(b)};return a.prototype.allocate=function(){var a;return 0===this._objpool.length?(a=new this._ConstructorFunction,a._objectPool=this,this.metrics.totalalloc++):(a=this._objpool.pop(),this.metrics.totalfree--),this._ConstructorFunction.apply(a,arguments),a},a.prototype.free=function(a){return this._objpool.push(a),this.metrics.totalfree++,this._ConstructorFunction.call(a),this},a.prototype.reset=function(a){this._ConstructorFunction.call(a);for(var b in this._ConstructorFunction.prototype)this._ConstructorFunction.prototype.hasOwnProperty(b)&&a.hasOwnProperty(b)&&delete a[b];return a},a.prototype.expand=function(a){for(var b;a--;)b=new this._ConstructorFunction,b._objectPool=this,this._objpool.push(b),this.metrics.totalalloc++;return this},a.prototype._clearMetrics=function(a){this.metrics.totalalloc=a||0,this.metrics.totalfree=0},a}),define("util/PubSub",function(){var a=function(){};return a.prototype.trigger=function(a){if("undefined"==typeof this._eventHandler)return this._eventHandler={},!1;if("undefined"==typeof this._eventHandler[a])return!1;var b,c,d=Array.prototype.splice.call(arguments,1),e=!0;for(b=0,c=this._eventHandler[a].length;c>b;b++)"undefined"==typeof this._eventHandler[a][b]||this._eventHandler[a][b].apply(this,d)||(e=!1);return e},a.prototype.on=function(a,b){var c=a.split(" ");if(c.length>1)return c.forEach(function(a){this.on.call(this,a,b)},this),this;if("undefined"==typeof this._eventHandler&&(this._eventHandler={}),"undefined"==typeof this._eventHandler[a]&&(this._eventHandler[a]=[]),"undefined"==typeof b&&"string"!=typeof a){for(var d in a)this.on(d,a[d]);return this}return this._eventHandler[a].push(b),this},a.prototype.off=function(a,b){var c=a.split(" ");if(c.length>1)return c.forEach(function(a){this.off.call(this,a,b)},this),this;if("undefined"==typeof this._eventHandler)return this._eventHandler={},this;if("undefined"==typeof this._eventHandler[a])return this;if("undefined"==typeof b)return delete this._eventHandler[a],this;for(var d=this._eventHandler[a],e=d.length;e--;)if(d[e]===b)return d.splice(e,1),this;return this},a.prototype.once=function(a,b){var c=a.split(" ");if(c.length>1)return c.forEach(function(a){this.once.call(this,a,b)},this),this;if("undefined"==typeof this._eventHandler&&(this._eventHandler={}),"undefined"==typeof this._eventHandler[a]&&(this._eventHandler[a]=[]),"undefined"==typeof b&&"string"!=typeof a){for(var d in a)this.once(d,a[d]);return this}return this._eventHandler[a].push(newHandler),this},a}),define("util/easing",{linear:function(a,b,c,d){return 0>=a?b:a>=d?b+c:b+c*(a/d)},easeInQuad:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*(a/=d)*a+b},easeOutQuad:function(a,b,c,d){return 0>=a?b:a>=d?b+c:-c*(a/=d)*(a-2)+b},easeInOutQuad:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},easeInCubic:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*(a/=d)*a*a+b},easeOutCubic:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*((a=a/d-1)*a*a+1)+b},easeInOutCubic:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d/2)<1?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b},easeInQuart:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*(a/=d)*a*a*a+b},easeOutQuart:function(a,b,c,d){return 0>=a?b:a>=d?b+c:-c*((a=a/d-1)*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},easeInQuint:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*(a/=d)*a*a*a*a+b},easeOutQuint:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*((a=a/d-1)*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d/2)<1?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},easeInSine:function(a,b,c,d){return 0>=a?b:a>=d?b+c:-c*Math.cos(a/d*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*Math.sin(a/d*(Math.PI/2))+b},easeInOutSine:function(a,b,c,d){return 0>=a?b:a>=d?b+c:-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return 0>=a?b:a>=d?b+c:0===a?b:c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return 0>=a?b:a>=d?b+c:a==d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d/2)<1?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b},easeInCirc:function(a,b,c,d){return 0>=a?b:a>=d?b+c:-c*(Math.sqrt(1-(a/=d)*a)-1)+b},easeOutCirc:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c*Math.sqrt(1-(a=a/d-1)*a)+b},easeInOutCirc:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d/2)<1?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b},easeInElastic:function(a,b,c,d){var e=1.70158,f=0,g=c;return 0>=a?b:a>=d?b+c:1==(a/=d)?b+c:(f||(f=.3*d),g<Math.abs(c)?(g=c,e=f/4):e=f/(2*Math.PI)*Math.asin(c/g),-(g*Math.pow(2,10*(a-=1))*Math.sin(2*(a*d-e)*Math.PI/f))+b)},easeOutElastic:function(a,b,c,d){var e=1.70158,f=0,g=c;return 0>=a?b:a>=d?b+c:1===(a/=d)?b+c:(f||(f=.3*d),g<Math.abs(c)?(g=c,e=f/4):e=f/(2*Math.PI)*Math.asin(c/g),g*Math.pow(2,-10*a)*Math.sin(2*(a*d-e)*Math.PI/f)+c+b)},easeInOutElastic:function(a,b,c,d){if(0>=a)return b;if(a>=d)return b+c;var e=1.70158,f=0,g=c;return 2==(a/=d/2)?b+c:(f||(f=.3*d*1.5),g<Math.abs(c)?(g=c,e=f/4):e=f/(2*Math.PI)*Math.asin(c/g),1>a?-.5*g*Math.pow(2,10*(a-=1))*Math.sin(2*(a*d-e)*Math.PI/f)+b:g*Math.pow(2,-10*(a-=1))*Math.sin(2*(a*d-e)*Math.PI/f)*.5+c+b)},easeInBack:function(a,b,c,d,e){return 0>=a?b:a>=d?b+c:(void 0===e&&(e=1.70158),c*(a/=d)*a*((e+1)*a-e)+b)},easeOutBack:function(a,b,c,d,e){return 0>=a?b:a>=d?b+c:(void 0===e&&(e=1.70158),c*((a=a/d-1)*a*((e+1)*a+e)+1)+b)},easeInOutBack:function(a,b,c,d,e){return 0>=a?b:a>=d?b+c:(void 0===e&&(e=1.70158),(a/=d/2)<1?c/2*a*a*(((e*=1.525)+1)*a-e)+b:c/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b)},easeInBounce:function(a,b,c,d){return 0>=a?b:a>=d?b+c:c-this.easeOutBounce(d-a,0,c,d)+b},easeOutBounce:function(a,b,c,d){return 0>=a?b:a>=d?b+c:(a/=d)<1/2.75?7.5625*c*a*a+b:2/2.75>a?c*(7.5625*(a-=1.5/2.75)*a+.75)+b:2.5/2.75>a?c*(7.5625*(a-=2.25/2.75)*a+.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+.984375)+b},easeInOutBounce:function(a,b,c,d){return 0>=a?b:a>=d?b+c:d/2>a?.5*this.easeInBounce(2*a,0,c,d)+b:.5*this.easeOutBounce(2*a-d,0,c,d)+.5*c+b},makeCubicBezierCurve:function(a,b,c,d){var e=function(e){var f=3*a,g=3*(c-a)-f,h=1-f-g,i=3*b,j=3*(d-b)-i,k=1-i-j,l=function(a){return((h*a+g)*a+f)*a},m=function(a){return((k*a+j)*a+i)*a},n=function(a){return(3*h*a+2*g)*a+f},o=function(a,b){var c,d,e,f,g,h;for(e=a,h=0;8>h;h++){if(f=l(e)-a,Math.abs(f)<b)return e;if(g=n(e),Math.abs(g)<1e-6)break;e-=f/g}if(c=0,d=1,e=a,c>e)return c;if(e>d)return d;for(;d>c;){if(f=l(e),Math.abs(f-a)<b)return e;a>f?c=e:d=e,e=.5*(d-c)+c}return e};return m(o(e,.005))};return function(a,b,c,d){return 0>=a?b:a>=d?b+c:b+c*e(a/d)}}});